name: Create GitHub Issue from Jira Task
on:
  repository_dispatch:
    types: [github-issue-create]

jobs:
  create-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse labels and determine template type
        id: parse_labels
        run: |
          # ë¼ë²¨ CSV ë¬¸ìì—´ ì¶”ì¶œ
          labels_csv="${{ github.event.client_payload.labels }}"
          
          # ì‰¼í‘œë¡œ ë¶„í• í•˜ì—¬ ë°°ì—´ ìƒì„±
          IFS=',' read -ra labels_array <<< "$labels_csv"
          
          # í…œí”Œë¦¿ íƒ€ì… ê²°ì • (ê¸°ë³¸ê°’: todo)
          template_type="todo"
          for label in "${labels_array[@]}"; do
            # ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´ ë¹„êµ
            label_lower=$(echo "$label" | tr '[:upper:]' '[:lower:]')
            case $label_lower in
              *bug*)
                template_type="bug"
                break
                ;;
              *feature*)
                template_type="feature"
                break
                ;;
            esac
          done
          
          # ê²°ê³¼ ì¶œë ¥
          echo "template_type=$template_type" >> $GITHUB_OUTPUT

      - name: Load and process template
        id: process_template
        run: |
          # ë³€ìˆ˜ ì¶”ì¶œ
          template_type="${{ steps.parse_labels.outputs.template_type }}"
          template_file=".github/ISSUE_TEMPLATE/$template_type-report.md"
          jira_description="${{ github.event.client_payload.description }}"
          assignee="${{ github.event.client_payload.assignee }}"
          parent_key="${{ github.event.client_payload.parent_key }}"
          issue_key="${{ github.event.client_payload.issue_key }}"
          
          # í• ë‹¹ ì •ë³´ í—¤ë” ìƒì„±
          header="### ğŸ“‹ í• ë‹¹ ì •ë³´\n- **í• ë‹¹ì:** $assignee\n- **ìƒìœ„ ì´ìŠˆ:** $parent_key\n\n"
          
          # í…œí”Œë¦¿ ë©”íƒ€ ë°ì´í„° ì œê±° í›„ ë‚´ìš© ë¡œë“œ
          template_content=$(awk '/^---$/ {count++; next} count < 2' "$template_file")
          
          # í…œí”Œë¦¿ ìœ í˜•ë³„ ì„¤ëª… ì„¹ì…˜ ì„¤ì •
          case $template_type in
            bug)
              section_header="### ğŸ ì–´ë–¤ ë²„ê·¸ì¸ê°€ìš”?"
              ;;
            feature)
              section_header="### ğŸš€ ì–´ë–¤ ê¸°ëŠ¥ì¸ê°€ìš”?"
              ;;
            *)
              section_header="### ğŸš€ ì´ìŠˆ ì„¤ëª…"
              ;;
          esac
          
          # Jira ì„¤ëª…ì„ í…œí”Œë¦¿ì— ì‚½ì…
          processed_content=$(
            echo -e "$header"
            echo "$template_content" | 
            awk -v header="$section_header" -v desc="$jira_description" '
              $0 ~ header { 
                print $0
                print desc
                getline
                next
              }
              /^>/ { next }
              1
            '
          )
          
          # ë©€í‹°ë¼ì¸ ì¶œë ¥ìœ¼ë¡œ body ì„¤ì •
          {
            echo "body<<EOF"
            echo "$processed_content"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Issue
        uses: actions/github-script@v6
        with:
          script: |
            const { summary, issue_key } = context.payload.client_payload;
            const body = `${{ steps.process_template.outputs.body }}`;
            const title = `[${issue_key}] ${summary}`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body
            });
