name: Create GitHub Issue from Jira Task
on:
  repository_dispatch:
    types: [github-issue-create]

jobs:
  create-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse labels and determine template type
        id: parse_labels
        run: |
          # ë¼ë²¨ JSON ë°°ì—´ ì¶”ì¶œ
          labels_json='${{ toJson(github.event.client_payload.labels) }}'
          
          # jqë¥¼ ì‚¬ìš©í•´ ë¼ë²¨ ë°°ì—´ íŒŒì‹±
          labels_array=$(echo "$labels_json" | jq -r '.[]')
          
          # í…œí”Œë¦¿ íƒ€ìž… ê²°ì • (ê¸°ë³¸ê°’: todo)
          template_type="todo"
          if echo "$labels_array" | grep -qi "bug"; then
            template_type="bug"
          elif echo "$labels_array" | grep -qi "feature"; then
            template_type="feature"
          fi
          
          # ê²°ê³¼ ì¶œë ¥
          echo "template_type=$template_type" >> $GITHUB_OUTPUT

      - name: Load and process template
        id: process_template
        run: |
          # ë³€ìˆ˜ ì¶”ì¶œ
          template_type="${{ steps.parse_labels.outputs.template_type }}"
          template_file=".github/ISSUE_TEMPLATE/$template_type-report.md"
          jira_description="${{ github.event.client_payload.description }}"
          assignee="${{ github.event.client_payload.assignee }}"
          parent_key="${{ github.event.client_payload.parent_key }}"
          issue_key="${{ github.event.client_payload.issue_key }}"
          
          # í• ë‹¹ ì •ë³´ í—¤ë” ìƒì„±
          header="### ðŸ“‹ í• ë‹¹ ì •ë³´\n- **í• ë‹¹ìž**: $assignee\n- **ìƒìœ„ ì´ìŠˆ**: $parent_key\n\n"
          
          # í…œí”Œë¦¿ ë‚´ìš© ë¡œë“œ
          template_content=$(cat "$template_file")
          
          # í…œí”Œë¦¿ ìœ í˜•ë³„ ì„¤ëª… ì„¹ì…˜ ì„¤ì •
          case $template_type in
            bug)
              section_header="### ðŸž ì–´ë–¤ ë²„ê·¸ì¸ê°€ìš”?"
              ;;
            feature)
              section_header="### ðŸš€ ì–´ë–¤ ê¸°ëŠ¥ì¸ê°€ìš”?"
              ;;
            *)
              section_header="### ðŸš€ ì´ìŠˆ ì„¤ëª…"
              ;;
          esac
          
          # Jira ì„¤ëª…ì„ í…œí”Œë¦¿ì— ì‚½ìž…
          processed_content=$(
            echo -e "$header"
            echo "$template_content" | 
            awk -v header="$section_header" -v desc="$jira_description" '
              $0 ~ header { 
                print $0
                print desc
                getline
                next
              }
              /^>/ { next }
              1
            '
          )
          
          echo "body=$processed_content" >> $GITHUB_OUTPUT

      - name: Create GitHub Issue
        uses: actions/github-script@v6
        with:
          script: |
            const { summary, issue_key } = context.payload.client_payload;
            const body = `${{ steps.process_template.outputs.body }}`;
            const title = `[${issue_key}] ${summary}`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body
            });
