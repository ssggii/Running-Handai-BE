name: Create Github Issue From Jira Task
on:
  repository_dispatch:
    types: [github-issue-create]

jobs:
  create-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Load and process template
        id: process_template
        run: |
          # í•„ìˆ˜ ë³€ìˆ˜ ì¶”ì¶œ
          template_type="${{ github.event.client_payload.template_type }}"
          template_file=".github/ISSUE_TEMPLATE/$template_type-report.md"
          jira_description="${{ github.event.client_payload.description }}"
          assignee="${{ github.event.client_payload.assignee }}"
          parent_key="${{ github.event.client_payload.parent_key }}"
          issue_key="${{ github.event.client_payload.issue_key }}"
          
          # í• ë‹¹ ì •ë³´ í—¤ë” ìƒì„±
          header="### ğŸ“‹ í• ë‹¹ ì •ë³´\n- **í• ë‹¹ì**: $assignee\n- **ìƒìœ„ ì´ìŠˆ**: $parent_key\n\n"
          
          # í…œí”Œë¦¿ ë‚´ìš© ë¡œë“œ
          template_content=$(cat "$template_file")
          
          # í…œí”Œë¦¿ ìœ í˜•ë³„ ì„¤ëª… ì„¹ì…˜ ì„¤ì •
          case $template_type in
            bug)
              section_header="### ğŸ ì–´ë–¤ ë²„ê·¸ì¸ê°€ìš”?"
              ;;
            feature)
              section_header="### ğŸš€ ì–´ë–¤ ê¸°ëŠ¥ì¸ê°€ìš”?"
              ;;
            *)
              section_header="### ğŸš€ ì´ìŠˆ ì„¤ëª…"
              ;;
          esac
          
          # Jira ì„¤ëª…ì„ í…œí”Œë¦¿ì— ì‚½ì…
          processed_content=$(
            echo -e "$header"
            echo "$template_content" | 
            awk -v header="$section_header" -v desc="$jira_description" '
              $0 ~ header { 
                print $0
                print desc
                getline # Skip placeholder line
                next
              }
              /^>/ { next } # > ì œê±°
              1
            '
          )
          
          echo "body=$processed_content" >> $GITHUB_OUTPUT

      - name: Create GitHub Issue
        uses: actions/github-script@v6
        with:
          script: |
            const { summary, issue_key } = context.payload.client_payload;
            const body = `${{ steps.process_template.outputs.body }}`;
            
            // ì´ìŠˆ ì œëª© ì„¤ì • (Jira Issue ë²ˆí˜¸ í¬í•¨)
            const title = `[${issue_key}] ${summary}`;
            
            // ì´ìŠˆ ìƒì„±
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body
            });
