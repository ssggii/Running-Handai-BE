# 워크플로우의 이름
name: Deploy SpringBoot to AWS EC2

# 워크플로우가 실행될 조건 (트리거)
on:
  push:
    branches: [ "main" ] # 'main' 브랜치에 push(merge) 이벤트가 발생했을 때 실행

# 실행될 작업(Job)들을 정의
jobs:
  build-and-deploy:
    # 작업이 실행될 가상 환경
    runs-on: ubuntu-latest

    # 작업의 단계(Step)들을 정의
    steps:
      # 1. 소스코드 체크아웃
      - name: Checkout
        uses: actions/checkout@v4

      # 2. JDK 21 설치 (Gradle 빌드를 위해 필요)
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. Gradle 캐시 설정
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4. gradlew 실행 권한 부여
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # 5. Gradle로 단위 테스트 실행
      - name: Run unit tests with Gradle
        run: ./gradlew test

      # 6. AWS 자격 증명 설정 (GitHub Secrets 사용)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      # 7. AWS ECR에 로그인
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 8. Docker 이미지 빌드, 태그 지정, ECR에 푸시, image_uri.txt 생성
      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: "runninghandai-app"
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          echo "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" > image_uri.txt

      # 9. 배포할 파일들만 모아서 압축
      - name: Make zip file
        run: zip -r deploy.zip appspec.yml image_uri.txt scripts

      # 10. 압축 파일을 S3 버킷에 업로드
      - name: Upload to S3
        env:
          S3_BUCKET_NAME: "runninghandai-bucket"
          IMAGE_TAG: ${{ github.sha }}
        run: |
          aws s3 cp deploy.zip s3://$S3_BUCKET_NAME/codedeploy-artifacts/$IMAGE_TAG-deploy.zip

      # 11. AWS CodeDeploy에 새로운 배포 생성 요청
      - name: Deploy to EC2 with CodeDeploy
        env:
          S3_BUCKET_NAME: "runninghandai-bucket"
          IMAGE_TAG: ${{ github.sha }}
        run: |
          aws deploy create-deployment \
            --application-name "runninghandai-app" \
            --deployment-group-name "runninghandai-app-prod" \
            --s3-location bucket=$S3_BUCKET_NAME,bundleType=zip,key=codedeploy-artifacts/$IMAGE_TAG-deploy.zip