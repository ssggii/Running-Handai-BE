name: Deploy SpringBoot to AWS EC2

on:
  push:
    branches: [ "main" ] # 'main' ë¸Œëœì¹˜ì— push(merge) ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì‹¤í–‰
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ì„ ìœ„í•œ íŠ¸ë¦¬ê±°

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout
        uses: actions/checkout@v4

      # 2. JDK 21 ì„¤ì¹˜ (Gradle ë¹Œë“œë¥¼ ìœ„í•´ í•„ìš”)
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. Gradle ìºì‹œ ì„¤ì •
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4. gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # 5. Gradleë¡œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Run unit tests with Gradle
        run: ./gradlew test

      # 6. AWS ìê²© ì¦ëª… ì„¤ì • (GitHub Secrets ì‚¬ìš©)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      # 7. AWS ECRì— ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 8. Docker ì´ë¯¸ì§€ ë¹Œë“œ, íƒœê·¸ ì§€ì •, ECRì— í‘¸ì‹œ, image_uri.txt ìƒì„±
      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: "runninghandai-app"
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          echo "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" > image_uri.txt

      # 9. ë°°í¬í•  íŒŒì¼ë“¤ë§Œ ëª¨ì•„ì„œ ì••ì¶•
      - name: Make zip file
        run: zip -r deploy.zip appspec.yml image_uri.txt scripts

      # 10. ì••ì¶• íŒŒì¼ì„ S3 ë²„í‚·ì— ì—…ë¡œë“œ
      - name: Upload to S3
        env:
          S3_BUCKET_NAME: "runninghandai-bucket"
          IMAGE_TAG: ${{ github.sha }}
        run: |
          aws s3 cp deploy.zip s3://$S3_BUCKET_NAME/codedeploy-artifacts/$IMAGE_TAG-deploy.zip

      # 11. AWS CodeDeployì— ë°°í¬ ìƒì„± ë° ì™„ë£Œ ëŒ€ê¸° â˜…â˜…â˜…
      - name: Deploy to EC2 with CodeDeploy
        env:
          APPLICATION_NAME: "runninghandai-app"
          DEPLOYMENT_GROUP_NAME: "runninghandai-app-prod"
          S3_BUCKET_NAME: "runninghandai-bucket"
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # 1. ë°°í¬ë¥¼ ìƒì„±í•˜ê³ , ê²°ê³¼ì—ì„œ deploymentIdë¥¼ ì¶”ì¶œí•˜ì—¬ ë³€ìˆ˜ì— ì €ì¥í•œë‹¤.
          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name $APPLICATION_NAME \
            --deployment-group-name $DEPLOYMENT_GROUP_NAME \
            --s3-location bucket=$S3_BUCKET_NAME,bundleType=zip,key=codedeploy-artifacts/$IMAGE_TAG-deploy.zip \
            --query 'deploymentId' --output text)

          echo "Deployment started with ID: $DEPLOYMENT_ID"

          # 2. í•´ë‹¹ ë°°í¬ê°€ 'ì„±ê³µ' ìƒíƒœê°€ ë  ë•Œê¹Œì§€ ëŒ€ê¸°í•œë‹¤.
          #    ë§Œì•½ ë°°í¬ê°€ ì‹¤íŒ¨í•˜ê±°ë‚˜ íƒ€ì„ì•„ì›ƒë˜ë©´, ì´ ëª…ë ¹ì–´ëŠ” ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¤ê³  ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤íŒ¨ ì²˜ë¦¬í•œë‹¤.
          aws deploy wait deployment-successful --deployment-id $DEPLOYMENT_ID
          
          echo "CodeDeploy deployment to EC2 successful!"

  send-slack-notification:
    name: Send Slack Notification
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: always()
    steps:
      - name: Send notification on success
        if: needs.build-and-deploy.result == 'success'
        uses: act10ns/slack@v2
        with:
          status: success
          message: |
            âœ… ë°°í¬ ì„±ê³µ!
            `main` ë¸Œëœì¹˜ì˜ ìµœì‹  ì½”ë“œê°€ EC2ì— ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.
            <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|ë°°í¬ ë¡œê·¸ ë³´ê¸°>
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Send notification on failure
        if: needs.build-and-deploy.result == 'failure'
        uses: act10ns/slack@v2
        with:
          status: failure
          message: |
            ğŸš¨ ë°°í¬ ì‹¤íŒ¨!
            ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì•„ë˜ ë§í¬ì—ì„œ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.
            <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|ì‹¤íŒ¨ ë¡œê·¸ ë³´ê¸°>
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}